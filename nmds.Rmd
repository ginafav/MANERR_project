---
title: "NMDS_02_20_26"
author: "Gina"
date: "2026-02-20"
output: html_document
---

```{r setup, include=FALSE}
library(vegan)
getwd()
###CoverM data for NMDS to analysis microbial community structure by Depth###
nmds_dat <- read.csv("/Users/gla589/Documents/Research/R_analysis_07_04/MAGs-vs-Samples-Depth.csv", header=TRUE, sep = ",")

#make community matrix - extract columns with abundance information
community = nmds_dat[,4:ncol(nmds_dat)]

#turn abundance data frame into a matrix
m_community = as.matrix(community)

set.seed(06131993)
nmds_stat = metaMDS(m_community, distance = "bray")
nmds_stat
plot(nmds_stat)

nmds_data.scores = as.data.frame(scores(nmds_stat)$sites)

#add columns to data frame 
nmds_data.scores$Samples = nmds_dat$Samples
nmds_data.scores$Vegetation = nmds_dat$Vegetation
nmds_data.scores$Depth = nmds_dat$Depth

head(nmds_data.scores)
cat("Stress =", round(nmds_stat$stress * 100, 1), "%")


#Let's plot
library(ggplot2)

nmds_data.scores$DepthName <- factor(nmds_data.scores$Depth,
                                levels = c("Top", "Middle", "Bottom"),
                                labels = c("Top", "Middle", "Bottom"))

p = ggplot(nmds_data.scores, aes(x = NMDS1, y = NMDS2, shape = DepthName, colour = DepthName)) + 
  geom_point(size = 4) +
  stat_ellipse(aes(group = DepthName, fill = DepthName), 
               geom = "polygon", alpha = 0.1, show.legend = FALSE) +
  theme(
    axis.text.y = element_text(colour = "black", size = 11),
    axis.text.x = element_text(colour = "black", size = 11),
    legend.text = element_text(colour = "black", size = 11, face = "bold"),
    legend.position = "right", 
    axis.title.y = element_text(colour = "black", size = 11, face = "bold"),
    axis.title.x = element_text(colour = "black", size = 11, face = "bold"),
    legend.title = element_text(colour = "black", size = 11, face = "bold"),
    panel.background = element_blank(),
    panel.border = element_rect(color = "black", fill = NA, linewidth = 1),
    legend.key = element_blank()
  ) +
  labs(x = "NMDS1", y = "NMDS2", colour = "DepthName", shape = "DepthName") +
  scale_color_manual(values = c("#009E73",  "slateblue", "coral")) +
  scale_fill_manual(values = c("#009E73", "slateblue", "coral")) + 
  scale_shape_manual(values = c(15, 16, 17)) # Depth categories

p
ggsave("nmds_depth_02_20_26.pdf", plot = p, width = 10, height = 7)


```

```{r}
###Lets do Stat###
#To determine if depth is an important factor for microbial presence and abundance:
#Convert to factor
library(vegan)
nmds_dat$Depth <- as.factor(nmds_dat$Depth)
table(nmds_dat$Depth)

#Perform Permanova
set.seed(06131993)
nmds_permanova <- adonis2(m_community ~ Depth, data = nmds_dat, method = "bray")

print(nmds_permanova)


#######################################################
# 1. Check dispersion homogeneity (PERMANOVA assumption)
dist <- vegdist(m_community, "bray")
disp <- betadisper(dist, nmds_dat$Depth)
anova(disp)
permutest(disp)  # Pairwise distances between centroids

# 2. Add Vegetation as covariate
nmds_dat$Vegetation <- as.factor(nmds_dat$Vegetation)
permanova_full <- adonis2(m_community ~ Depth + Vegetation, 
                          data = nmds_dat, method = "bray", permutations = 999)
print(permanova_full)
```


```{r}
library(vegan)
####CoverM data for NMDS to analysis microbial community structure by Vegetation###
vegdat <- read.csv("/Users/gla589/Documents/Research/R_analysis_07_04/MAGs-vs-Samples-Vegetation.csv", header=TRUE, sep = ",")

#make community matrix - extract columns with abundance information
vegcom = vegdat[,4:ncol(vegdat)]

#turn abundance data frame into a matrix
veg_community = as.matrix(vegcom)

set.seed(06131993)
nmds_vegstat = metaMDS(veg_community, distance = "bray")
nmds_vegstat
plot(nmds_vegstat)

veg_data.scores = as.data.frame(scores(nmds_vegstat)$sites)

#add columns to data frame 
veg_data.scores$Samples = vegdat$Samples
veg_data.scores$Vegetation = vegdat$Vegetation
veg_data.scores$Depth = vegdat$Depth

head(veg_data.scores)
cat("Stress =", round(nmds_vegstat$stress * 100, 1), "%")


veg_data.scores$Vegetation <- as.factor(veg_data.scores$Vegetation)
###Plotting by just vegetation type here to get a good look at the clusters###
library(ggplot2)

v <- ggplot(veg_data.scores, aes(x = NMDS1, y = NMDS2, shape = Vegetation, colour = Vegetation)) + 
  geom_point(size = 4) +
  stat_ellipse(data = subset(veg_data.scores, Vegetation != "Water"),
               aes(group = Vegetation, fill = Vegetation), 
               geom = "polygon", alpha = 0.1, show.legend = FALSE) +
  labs(x = "NMDS1", y = "NMDS2", colour = "Vegetation", shape = "Vegetation") +
  
  # THREE SEPARATE scale calls (NOT nested!)
  scale_color_manual(values = c("#009E73", "coral", "slateblue", "darkred")) +
  scale_fill_manual(values = c("Mangrove" = "#009E73", 
                               "Seagrass" = "coral", 
                               "Sporobolus" = "slateblue")) +
  scale_shape_manual(values = c(16, 17, 15, 18)) +  # 4 shapes for 4 veg types
  
  theme(
    axis.text.y = element_text(colour = "black", size = 11),
    axis.text.x = element_text(colour = "black", size = 11),
    legend.text = element_text(colour = "black", size = 11, face = "bold"),
    legend.position = "right", 
    axis.title.y = element_text(colour = "black", size = 11, face = "bold"),
    axis.title.x = element_text(colour = "black", size = 11, face = "bold"),
    legend.title = element_text(colour = "black", size = 11, face = "bold"),
    panel.background = element_blank(),
    panel.border = element_rect(color = "black", fill = NA, linewidth = 1),
    legend.key = element_blank()
  )

v

ggsave("nmds_veg_02_20_26.pdf", plot = v, width = 10, height = 7)

```


```{r}
###Lets do Stat on Vegetation###
#To determine if Vegetation is an important factor for microbial presence and abundance:
#Covert to factor
vegdat$Vegetation <- as.factor(vegdat$Vegetation)
table(vegdat$Vegetation)

#Perform Permanova
set.seed(06131993)
permanova_veg <- adonis2(veg_community ~ Vegetation, data = vegdat, method = "bray")

print(permanova_veg)


# Same validation as Depth
dist_veg <- vegdist(veg_community, "bray")
disp_veg <- betadisper(dist_veg, vegdat$Vegetation)
anova(disp_veg)


# Pairwise centroid distances
permutest(disp_veg)
TukeyHSD(disp_veg)  # Which vegetation types have different spreads
 #Water is the outlier
#"Vegetation type explained 32.0% of MAG community variation (PERMANOVA: F_{3,51} = 8.007, P < #0.001), 
 #with Water samples (n = 2) exhibiting significantly lower dispersion than 
 #rooted vegetation (TukeyHSD: Water vs Mangrove P = 0.007; vs Seagrass P = 0.027). 
# This tight Water clustering likely reflects limited sampling (n = 2) rather 
 #than ecological constraint."
```

